Redis Distributed Lock ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤ Cron-—Å–µ—Ä–≤–∏—Å–µ

–≠—Ç–æ—Ç README –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ª–æ–∫–∞ –≤ Redis, –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω, –∏ –∫–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ cron-—Å–µ—Ä–≤–∏—Å–∞.

‚ùì –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Redis-–ª–æ–∫

–ö–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—É—Å–∫–∞—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π), –≤–∞–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –≤—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –Ω–∞—á–∏–Ω–∞—é—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

–î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ª–æ–∫ –Ω–∞ Redis. –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å —Å–º–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –ª–æ–∫ ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç –æ—à–∏–±–∫—É –≤–∏–¥–∞:

redis lock: already acquired

–∏ –Ω–µ –∑–∞–ø—É—Å—Ç—è—Ç —Ç—è–∂—ë–ª—É—é –∑–∞–¥–∞—á—É.


‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫
	1.	–ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É SET —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ NX –∏ EX, –Ω–∞–ø—Ä–∏–º–µ—Ä:

SET lock_key value NX EX 60

	2.	–£—Å–ª–æ–≤–∏–µ NX –æ–∑–Ω–∞—á–∞–µ—Ç: —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
	3.	–ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ª–æ–∫ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥—Ä—É–≥–æ–π –∏–Ω—Å—Ç–∞–Ω—Å):
	‚Ä¢	Redis –≤–µ—Ä–Ω—ë—Ç nil.
	‚Ä¢	–í –∫–æ–¥–µ –±—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ:
‚Äúredis lock already acquired‚Äù
	4.	–ï—Å–ª–∏ –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:
	‚Ä¢	–ò–Ω—Å—Ç–∞–Ω—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫—Ä–æ–Ω-–∑–∞–¥–∞—á—É.
	‚Ä¢	–ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ ‚Äî —É–¥–∞–ª—è–µ—Ç –∫–ª—é—á (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ª–æ–∫).

‚∏ª

üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –ª–æ–∫–∞

1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–ü–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–π cron-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:

docker stop cron-service

2. –û—á–∏—Å—Ç–∏—Ç–µ Redis (—Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!)

‚ùó –í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ Redis.

redis-cli FLUSHALL

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–ª—é—á–µ–π –Ω–µ—Ç:

redis-cli KEYS '*'

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø—É—Å—Ç–æ–π –≤—ã–≤–æ–¥.

‚∏ª

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ docker-compose:

docker-compose up --scale cron-service=3 --build

–ò–ª–∏ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ Kubernetes:

kubectl scale deployment cron-service --replicas=3


‚∏ª

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

–û—Ç–∫—Ä–æ–π—Ç–µ –ª–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤/–ø–æ–¥–æ–≤:

docker-compose logs -f cron-service

–û–∂–∏–¥–∞–µ–º–∞—è –∫–∞—Ä—Ç–∏–Ω–∞:
	‚Ä¢	–û–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å –ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:

redis lock acquired, starting job


	‚Ä¢	–û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:

redis lock already acquired



–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–≤–æ–¥–∏—Ç "redis lock already acquired", –∑–Ω–∞—á–∏—Ç –ª–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

‚∏ª

üõ† –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª—é—á–∏ –ª–æ–∫–∞

redis-cli KEYS 'lock*'

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL –ª–æ–∫–∞

redis-cli TTL lock_key

–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª—é—á –ª–æ–∫–∞

redis-cli DEL lock_key


‚∏ª

‚úîÔ∏è –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
	‚Ä¢	–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫—Ä–æ–Ω-–∑–∞–¥–∞—á—É.
	‚Ä¢	–û—Å—Ç–∞–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—è—Ç –ª–æ–≥ "redis lock already acquired".
	‚Ä¢	–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –∫–ª—é—á –≤ Redis –∏—Å—á–µ–∑–∞–µ—Ç –∏–ª–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç –ø–æ TTL.

